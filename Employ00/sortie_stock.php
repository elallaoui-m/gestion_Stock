<?php
/* Displays user information and some useful messages */
session_start();

// Check if user is logged in using the session variable
if ( $_SESSION['logged_in'] != 1 ) {
  $_SESSION['message'] = "You must log in before viewing your profile page!";
  header("location: error.php");    
}
else {
    // Makes it easier to read
    $first_name = $_SESSION['first_name'];
    $last_name = $_SESSION['last_name'];
    $email = $_SESSION['email'];
    //$active = $_SESSION['active'];
}
?>


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
	<title>Gestionnaire De Stock</title>
	<link rel="stylesheet" href="css/style.css" type="text/css" media="all" />
</head>
<body>
<!-- Header -->
<div id="header">
	<div class="shell">
		<!-- Logo + Top Nav -->
		<div id="top">
			<h1><a href="#">Sortie Stock</a></h1>
			<div id="top-navigation">
				Bonjour, <a href="profile.php"><strong><?php echo $first_name ; ?></strong></a>
				<span>|</span>
				<a href="modif/modif_usr.php">Parametres De Profile</a>
				<span>|</span>
				<a href="logout.php">Déconnexion</a>
			</div>
		</div>
		<!-- End Logo + Top Nav -->
		
		<!-- Main Nav -->
		<div id="navigation">
			<ul>
			    <li><a href="entree_stock.php"  ><span>Entree Stock</span></a></li>
			    <li><a href="sortie_stock.php" class="active"><span>Sortie Stock</span></a></li>
			    <li><a href="inven_stock.php"><span>Inventaire</span></a></li>
			    <li><a href="article.php"><span>Articles</span></a></li>
			    <li><a href="employee.php"><span>Employés</span></a></li>
			    <li><a href="client.php"  ><span>Clients</span></a></li>
			    <li><a href="fournisseur.php" ><span>Fournisseurs</span></a></li>
			</ul>
		</div>
		<!-- End Main Nav -->
	</div>
</div>
<!-- End Header -->

<!-- Container -->
<div id="container">
	<div class="shell">
		
		
		<br />
		<!-- Main -->
		<div id="main">
			<div class="cl">&nbsp;</div>
			
			<!-- Content -->
			<div id="content">
				
				<!-- Box -->
				<div class="box">
					<!-- Box Head -->
					<div class="box-head">
						<h2 class="left">Sortie Stock</h2>
					</div>
					<!-- End Box Head -->	

					<!-- Table -->
					<div class="table">
						<table width="100%" border="0" cellspacing="0" cellpadding="0">

							<tr>
								<th>Recorde</th>
								<th>Article ID</th>
								<th>Date Sortie</th>
								<th>Quantite</th>
								<th width="110" class="ac">Parametres</th>
							</tr>


							<?php

							$dbt = new PDO('mysql:host=localhost;dbname=gestion_stock','root','');

							if (isset($_POST['filtre_type']) && isset($_POST['filtre'])) {
								$sql="SELECT * FROM sortie_stock order by ".$_POST['filtre_type']."";


							}
							else $sql = "SELECT * FROM sortie_stock order by req_sortie";

	$reps=$dbt->query($sql);
	while($donne = $reps->fetch())
	{
		echo  "<tr>

								<td>".$donne['req_sortie']."</td>
								<td>".$donne['art_id']."</td>
								<td>".$donne['date_sortie']."</td>
								<td>".$donne['qnte_sortie']."</td>
								<td><a href='http://localhost/Employ00/sortie_stock.php?sup=1&req_sortie=".$donne['req_sortie']."' class='ico del'>Supprimer</a><a href='http://localhost/Employ00/modif/modif_srt.php?req_sortie=".$donne['req_sortie']."' class='ico edit'>Modifier</a></td>
							</tr> " ;
	}

	echo '</table>';
	?>
							
						</table>
						
					</div>
					<!-- Table -->
					
				</div>
				<!-- End Box -->
				
				<!-- Box -->
				<div class="box" id="add_new_clnt" style="display: none">
					<!-- Box Head -->
					<div class="box-head">
						<h2>Nouvelle inserction</h2>
					</div>
					<!-- End Box Head -->
					
					<form action="sortie_stock.php" method="post">
						
						<!-- Form -->
						<div class="form">


								<p>
									<span class="req">max 100 symbols</span>
									<label>Article ID <span>(Required Field)</span></label>
									<select name="art_id" type="text" class="field size1" >

									<?php
			
			$dbt = new PDO('mysql:host=localhost;dbname=gestion_stock','root','');
			$sql = " SELECT art_id , (somEntre-somSortie) as stock
 from (
  (select  COALESCE( sum(`qnte_entree`) ,0) as somEntre , `art_id`
  from entree_stock
  GROUP BY `art_id`)
   as entree
 
 left join
 
 (select  COALESCE( sum(`qnte_sortie`) ,0) as somSortie , `art_id`
  from sortie_stock
  GROUP BY `art_id`)
  
   as sortie
   USING (art_id)

    )  join article USING (art_id) 
   
   WHERE somEntre > somSortie ";

			$reps=$dbt->query($sql);
			while($donne = $reps->fetch())
			{
				echo "<option value=".$donne['art_id'].">".$donne['art_id']."</option>" ;
			}


			$sql = "select art_id from article where art_id in (select art_id from entree_stock) and art_id not in (select art_id from sortie_stock)";

			$reps=$dbt->query($sql);
			while($donne = $reps->fetch())
			{
				echo "<option value=".$donne['art_id'].">".$donne['art_id']."</option>" ;
			}
		?>
									</select>
								</p>	
								<p>
									<span class="req">max 100 symbols</span>
									<label>Quantite <span>(Required Field)</span></label>
									<input name="qnte_sortie" type="number" class="field size1" />
								</p>

								
							
						</div>
						<!-- End Form -->
						
						<!-- Form Buttons -->
						<div class="buttons">
							<input type="submit" class="button" value="submit" />
						</div>
						<!-- End Form Buttons -->
					</form>
				</div>
				<!-- End Box -->


				<!-- Box -->

			</div>
			<!-- End Content -->
			
			<!-- Sidebar -->
			<div id="sidebar">
				
				<!-- Box -->
				<div class="box">
					
					<!-- Box Head -->
					<div class="box-head">
						<h2>Management</h2>
					</div>
					<!-- End Box Head-->
					
					<div class="box-content">
						<a href="#" class="add-button" onclick='toggle("add_new_clnt")'><span >Nouvelle Insertion</span></a>
						<div class="cl">&nbsp;</div><br>
						<!-- Sort -->
						<form class="sort" method="post" action="sortie_stock.php">
							<label>Sort by</label>
							<select class="field" name="filtre_type">
						 		<option name='filtre_type' value="req_sortie">Recorde</option>
								<option name='filtre_type' value="art_id">Article ID</option>
								<option name='filtre_type' value="date_sortie">Date</option>
								<option name='filtre_type' value="qnte_sortie">Quantite</option>
							</select> <br>
							<input class="button" type="submit" name="filtre" value="filtrer">
						</form>
						<!-- End Sort -->
						
					</div>
				</div>
				<!-- End Box -->
			</div>
			<!-- End Sidebar -->
			
			<div class="cl">&nbsp;</div>			
		</div>
		<!-- Main -->
	</div>
</div>
<!-- End Container -->

<!-- Footer -->
<div id="footer">
	<div class="shell">
		<span class="left">&copy; 2017 - ENIAC IT</span>
		<span class="right">
	</div>
</div>
<!-- End Footer -->


<script type="text/javascript">
	
	function toggle(ID)
	{
		X = document.getElementById('add_new_clnt');

		if(X.style.display === 'none')
			X.style.display = 'block';
		else 
			X.style.display =  'none';
		
	}

	</script>
	
</body>
</html>

<?php 

		
		$dbt = new PDO('mysql:host=localhost;dbname=gestion_stock','root','');

if(isset($_POST['art_id']) && isset($_POST['qnte_sortie']) )
{
	$aID=$_POST["art_id"];
	$date_sortie=date('Y-m-d H:i:s');
	$qnte=$_POST["qnte_sortie"];
	
	$sql="INSERT INTO sortie_stock (art_id,date_sortie,qnte_sortie) VALUES  ('$aID','$date_sortie','$qnte')";

		$dbt->query($sql);

		echo "<script type='text/javascript'>document.location.replace('sortie_stock.php');</script>";
}


else if ( isset($_GET['req_sortie']) && isset($_GET['sup']))
	 {
		
		$var1=$_GET["req_sortie"];
		$sqls="DELETE FROM sortie_stock WHERE req_sortie='$var2' ";


		$dbt->query($sqls);

		echo "<script type='text/javascript'>document.location.replace('sortie_stock.php');</script>";
	}


?>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       